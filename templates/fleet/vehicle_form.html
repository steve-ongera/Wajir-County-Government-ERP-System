{% extends 'admin_base.html' %}
{% load static %}

{% block title %}{% if vehicle %}Edit Vehicle{% else %}Add Vehicle{% endif %} - Fleet Management{% endblock %}

{% block extra_css %}
<style>
    .breadcrumb {
        padding: 0;
        margin-bottom: 20px;
        font-size: 14px;
        list-style: none;
        display: flex;
        flex-wrap: wrap;
    }

    .breadcrumb-item {
        color: #64748B;
    }

    .breadcrumb-item + .breadcrumb-item::before {
        content: "/ ";
        color: #94A3B8;
        padding: 0 8px;
    }

    .breadcrumb a {
        color: #3498db;
        text-decoration: none;
    }

    .section-container {
        background: white;
        border-radius: 8px;
        padding: 24px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        margin-bottom: 24px;
        border: 1px solid #E2E8F0;
    }

    .page-header {
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 1px solid #F1F5F9;
    }

    .page-title {
        font-size: 22px;
        font-weight: 600;
        color: #1E293B;
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
    }

    .form-section {
        margin-bottom: 32px;
    }

    .section-title {
        font-size: 16px;
        font-weight: 600;
        color: #1E293B;
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 2px solid #E2E8F0;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }

    .form-group {
        margin-bottom: 0;
    }

    .form-group label {
        display: block;
        font-size: 14px;
        font-weight: 600;
        color: #334155;
        margin-bottom: 8px;
    }

    .form-group label .required {
        color: #e74c3c;
        margin-left: 2px;
    }

    .form-control, .form-select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #E2E8F0;
        border-radius: 6px;
        font-size: 14px;
        transition: all 0.3s ease;
        background: white;
    }

    .form-control:focus, .form-select:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    .form-check {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 8px;
    }

    .form-check-input {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    .form-check-label {
        font-size: 14px;
        color: #334155;
        cursor: pointer;
        margin: 0;
    }

    .form-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 32px;
        padding-top: 24px;
        border-top: 1px solid #F1F5F9;
    }

    .btn {
        padding: 12px 24px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border: none;
        transition: all 0.3s ease;
    }

    .btn-primary {
        background: #3498db;
        color: white;
    }

    .btn-primary:hover {
        background: #2980b9;
    }

    .btn-secondary {
        background: white;
        color: #64748B;
        border: 1px solid #E2E8F0;
    }

    .btn-secondary:hover {
        background: #F8FAFC;
    }

    .help-text {
        font-size: 12px;
        color: #64748B;
        margin-top: 4px;
    }

    .alert {
        padding: 12px 16px;
        border-radius: 6px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .alert-danger {
        background: #FEE2E2;
        color: #991B1B;
        border: 1px solid #FCA5A5;
    }

    .full-width {
        grid-column: 1 / -1;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{% url 'admin_dashboard' %}">
                    <i class="bi bi-house-door"></i> Dashboard
                </a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'vehicle_list' %}">Fleet Vehicles</a>
            </li>
            <li class="breadcrumb-item active">{% if vehicle %}Edit{% else %}Add{% endif %} Vehicle</li>
        </ol>
    </nav>

    <div class="section-container">
        <div class="page-header">
            <h1 class="page-title">
                <i class="fas fa-truck"></i>
                {% if vehicle %}Edit Vehicle - {{ vehicle.fleet_number }}{% else %}Add New Vehicle{% endif %}
            </h1>
        </div>

        {% if messages %}
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">
                <i class="bi bi-exclamation-triangle"></i>
                {{ message }}
            </div>
            {% endfor %}
        {% endif %}

        <form method="post">
            {% csrf_token %}
            
            <!-- Basic Information -->
            <div class="form-section">
                <h6 class="section-title">
                    <i class="bi bi-info-circle"></i>
                    Basic Information
                </h6>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="fleet_number">Fleet Number <span class="required">*</span></label>
                        <input type="text" class="form-control" id="fleet_number" name="fleet_number" 
                               value="{{ vehicle.fleet_number|default:'' }}" required
                               {% if vehicle %}readonly{% endif %}>
                        <small class="help-text">Unique identifier for the vehicle</small>
                    </div>

                    <div class="form-group">
                        <label for="registration_number">Registration Number <span class="required">*</span></label>
                        <input type="text" class="form-control" id="registration_number" name="registration_number" 
                               value="{{ vehicle.registration_number|default:'' }}" required>
                    </div>

                    <div class="form-group">
                        <label for="vehicle_type">Vehicle Type <span class="required">*</span></label>
                        <select class="form-select" id="vehicle_type" name="vehicle_type" required>
                            <option value="">Select Type</option>
                            <option value="car" {% if vehicle.vehicle_type == 'car' %}selected{% endif %}>Car</option>
                            <option value="truck" {% if vehicle.vehicle_type == 'truck' %}selected{% endif %}>Truck</option>
                            <option value="bus" {% if vehicle.vehicle_type == 'bus' %}selected{% endif %}>Bus</option>
                            <option value="motorcycle" {% if vehicle.vehicle_type == 'motorcycle' %}selected{% endif %}>Motorcycle</option>
                            <option value="machinery" {% if vehicle.vehicle_type == 'machinery' %}selected{% endif %}>Machinery/Plant</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="make">Make <span class="required">*</span></label>
                        <input type="text" class="form-control" id="make" name="make" 
                               value="{{ vehicle.make|default:'' }}" required>
                    </div>

                    <div class="form-group">
                        <label for="model">Model <span class="required">*</span></label>
                        <input type="text" class="form-control" id="model" name="model" 
                               value="{{ vehicle.model|default:'' }}" required>
                    </div>

                    <div class="form-group">
                        <label for="year">Year <span class="required">*</span></label>
                        <input type="number" class="form-control" id="year" name="year" 
                               value="{{ vehicle.year|default:'' }}" required min="1950" max="2030">
                    </div>
                </div>
            </div>

            <!-- Assignment Information -->
            <div class="form-section">
                <h6 class="section-title">
                    <i class="bi bi-building"></i>
                    Assignment Information
                </h6>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="department">Department <span class="required">*</span></label>
                        <select class="form-select" id="department" name="department" required>
                            <option value="">Select Department</option>
                            {% for dept in departments %}
                            <option value="{{ dept.id }}" {% if vehicle.department.id == dept.id %}selected{% endif %}>
                                {{ dept.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="current_driver">Current Driver</label>
                        <select class="form-select" id="current_driver" name="current_driver">
                            <option value="">Not Assigned</option>
                            {% for driver in drivers %}
                            <option value="{{ driver.id }}" 
                                    {% if vehicle.current_driver.id == driver.id %}selected{% endif %}>
                                {{ driver.get_full_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    {% if vehicle %}
                    <div class="form-group">
                        <label for="status">Status</label>
                        <select class="form-select" id="status" name="status">
                            <option value="active" {% if vehicle.status == 'active' %}selected{% endif %}>Active</option>
                            <option value="maintenance" {% if vehicle.status == 'maintenance' %}selected{% endif %}>Under Maintenance</option>
                            <option value="inactive" {% if vehicle.status == 'inactive' %}selected{% endif %}>Inactive</option>
                        </select>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Technical Specifications -->
            <div class="form-section">
                <h6 class="section-title">
                    <i class="bi bi-gear"></i>
                    Technical Specifications
                </h6>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="fuel_type">Fuel Type <span class="required">*</span></label>
                        <select class="form-select" id="fuel_type" name="fuel_type" required>
                            <option value="">Select Fuel Type</option>
                            <option value="Petrol" {% if vehicle.fuel_type == 'Petrol' %}selected{% endif %}>Petrol</option>
                            <option value="Diesel" {% if vehicle.fuel_type == 'Diesel' %}selected{% endif %}>Diesel</option>
                            <option value="Electric" {% if vehicle.fuel_type == 'Electric' %}selected{% endif %}>Electric</option>
                            <option value="Hybrid" {% if vehicle.fuel_type == 'Hybrid' %}selected{% endif %}>Hybrid</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="engine_capacity">Engine Capacity</label>
                        <input type="text" class="form-control" id="engine_capacity" name="engine_capacity" 
                               value="{{ vehicle.engine_capacity|default:'' }}" placeholder="e.g., 2000cc">
                    </div>

                    <div class="form-group">
                        <label for="current_mileage">Current Mileage (km) <span class="required">*</span></label>
                        <input type="number" class="form-control" id="current_mileage" name="current_mileage" 
                               value="{{ vehicle.current_mileage|default:0 }}" required min="0">
                    </div>
                </div>
            </div>

            <!-- Purchase & Registration -->
            <div class="form-section">
                <h6 class="section-title">
                    <i class="bi bi-receipt"></i>
                    Purchase & Registration
                </h6>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="purchase_date">Purchase Date <span class="required">*</span></label>
                        <input type="date" class="form-control" id="purchase_date" name="purchase_date" 
                               value="{{ vehicle.purchase_date|date:'Y-m-d' }}" required>
                    </div>

                    <div class="form-group">
                        <label for="purchase_cost">Purchase Cost (KES) <span class="required">*</span></label>
                        <input type="number" class="form-control" id="purchase_cost" name="purchase_cost" 
                               value="{{ vehicle.purchase_cost|default:'' }}" required min="0" step="0.01">
                    </div>

                    <div class="form-group">
                        <label for="insurance_expiry">Insurance Expiry Date <span class="required">*</span></label>
                        <input type="date" class="form-control" id="insurance_expiry" name="insurance_expiry" 
                               value="{{ vehicle.insurance_expiry|date:'Y-m-d' }}" required>
                    </div>

                    <div class="form-group">
                        <label for="inspection_due">Inspection Due Date <span class="required">*</span></label>
                        <input type="date" class="form-control" id="inspection_due" name="inspection_due" 
                               value="{{ vehicle.inspection_due|date:'Y-m-d' }}" required>
                    </div>
                </div>
            </div>

            <!-- GPS Tracking -->
            <div class="form-section">
                <h6 class="section-title">
                    <i class="bi bi-geo-alt"></i>
                    GPS Tracking
                </h6>
                <div class="form-grid">
                    <div class="form-group">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="has_gps" name="has_gps"
                                   {% if vehicle.has_gps %}checked{% endif %}>
                            <label class="form-check-label" for="has_gps">
                                Vehicle has GPS tracking device
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="gps_device_id">GPS Device ID</label>
                        <input type="text" class="form-control" id="gps_device_id" name="gps_device_id" 
                               value="{{ vehicle.gps_device_id|default:'' }}" placeholder="GPS device identifier">
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
                <a href="{% if vehicle %}{% url 'vehicle_detail' vehicle.fleet_number %}{% else %}{% url 'vehicle_list' %}{% endif %}" 
                   class="btn btn-secondary">
                    <i class="bi bi-x-circle"></i>
                    Cancel
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-circle"></i>
                    {% if vehicle %}Update Vehicle{% else %}Register Vehicle{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // Toggle GPS Device ID field based on GPS checkbox
    document.getElementById('has_gps').addEventListener('change', function() {
        const gpsDeviceField = document.getElementById('gps_device_id');
        if (this.checked) {
            gpsDeviceField.removeAttribute('disabled');
        } else {
            gpsDeviceField.value = '';
        }
    });
</script>
{% endblock %}