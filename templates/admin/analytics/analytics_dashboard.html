{% extends 'admin_base.html' %}
{% load humanize %}
{% load static %}

{% block title %}Analytics Dashboard - Wajir County ERP{% endblock %}

{% block extra_css %}
<style>
    /* Page Header */
    .analytics-header {
        background: linear-gradient(135deg, #139145 0%, #0f7a38 100%);
        color: white;
        padding: 32px 24px;
        border-radius: 12px;
        margin-bottom: 24px;
        box-shadow: 0 4px 12px rgba(19, 145, 69, 0.2);
    }

    .analytics-header h1 {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 8px;
    }

    .analytics-header p {
        font-size: 16px;
        opacity: 0.9;
        margin: 0;
    }

    /* Filter Panel */
    .filter-panel {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        margin-bottom: 24px;
        border: 1px solid #E2E8F0;
    }

    .filter-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 2px solid #F1F5F9;
    }

    .filter-title {
        font-size: 18px;
        font-weight: 600;
        color: #1E293B;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .filter-title i {
        color: #139145;
    }

    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 20px;
    }

    .filter-group label {
        display: block;
        font-size: 13px;
        font-weight: 600;
        color: #64748B;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .filter-group select,
    .filter-group input {
        width: 100%;
        padding: 10px 14px;
        border: 1px solid #E2E8F0;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s ease;
    }

    .filter-group select:focus,
    .filter-group input:focus {
        outline: none;
        border-color: #139145;
        box-shadow: 0 0 0 3px rgba(19, 145, 69, 0.1);
    }

    .filter-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    .btn {
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
    }

    .btn-primary {
        background: #139145;
        color: white;
    }

    .btn-primary:hover {
        background: #0f7a38;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(19, 145, 69, 0.3);
    }

    .btn-secondary {
        background: white;
        color: #64748B;
        border: 1px solid #E2E8F0;
    }

    .btn-secondary:hover {
        background: #F8FAFC;
        border-color: #CBD5E1;
    }

    .btn-export {
        background: #C18B5A;
        color: white;
    }

    .btn-export:hover {
        background: #a8754d;
    }

    /* KPI Cards */
    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .kpi-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border: 1px solid #E2E8F0;
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .kpi-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
    }

    .kpi-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: linear-gradient(90deg, #139145, #0f7a38);
    }

    .kpi-card.orange::before {
        background: linear-gradient(90deg, #C18B5A, #a8754d);
    }

    .kpi-card.red::before {
        background: linear-gradient(90deg, #CD4F27, #b33d1e);
    }

    .kpi-card.blue::before {
        background: linear-gradient(90deg, #3B82F6, #2563EB);
    }

    .kpi-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 16px;
    }

    .kpi-icon {
        width: 48px;
        height: 48px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 22px;
        background: rgba(19, 145, 69, 0.1);
        color: #139145;
    }

    .kpi-card.orange .kpi-icon {
        background: rgba(193, 139, 90, 0.1);
        color: #C18B5A;
    }

    .kpi-card.red .kpi-icon {
        background: rgba(205, 79, 39, 0.1);
        color: #CD4F27;
    }

    .kpi-card.blue .kpi-icon {
        background: rgba(59, 130, 246, 0.1);
        color: #3B82F6;
    }

    .kpi-trend {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
    }

    .kpi-trend.up {
        background: rgba(19, 145, 69, 0.1);
        color: #139145;
    }

    .kpi-trend.down {
        background: rgba(205, 79, 39, 0.1);
        color: #CD4F27;
    }

    .kpi-value {
        font-size: 32px;
        font-weight: 700;
        color: #1E293B;
        margin-bottom: 8px;
        line-height: 1;
    }

    .kpi-label {
        font-size: 14px;
        color: #64748B;
        font-weight: 500;
    }

    /* Chart Cards */
    .chart-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 24px;
        margin-bottom: 30px;
    }

    .chart-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border: 1px solid #E2E8F0;
        overflow: hidden;
    }

    .chart-card.full-width {
        grid-column: 1 / -1;
    }

    .chart-header {
        padding: 20px 24px;
        border-bottom: 1px solid #E2E8F0;
        background: #F8FAFC;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .chart-title {
        font-size: 16px;
        font-weight: 600;
        color: #1E293B;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .chart-title i {
        color: #139145;
    }

    .chart-body {
        padding: 24px;
        min-height: 300px;
    }

    .chart-container {
        position: relative;
        width: 100%;
        height: 350px;
    }

    /* Tabs */
    .nav-tabs-custom {
        display: flex;
        border-bottom: 2px solid #E2E8F0;
        margin-bottom: 24px;
        gap: 4px;
        background: white;
        padding: 0 24px;
        border-radius: 12px 12px 0 0;
    }

    .nav-tab {
        padding: 16px 24px;
        border: none;
        border-bottom: 3px solid transparent;
        background: transparent;
        color: #64748B;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .nav-tab:hover {
        color: #139145;
        background: rgba(19, 145, 69, 0.05);
    }

    .nav-tab.active {
        color: #139145;
        border-bottom-color: #139145;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
        animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Table Styles */
    .data-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }

    .data-table thead th {
        background: #F8FAFC;
        padding: 14px 16px;
        text-align: left;
        font-size: 12px;
        font-weight: 700;
        color: #64748B;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 2px solid #E2E8F0;
    }

    .data-table tbody td {
        padding: 16px;
        border-bottom: 1px solid #F1F5F9;
        font-size: 14px;
        color: #334155;
    }

    .data-table tbody tr:hover {
        background-color: #F8FAFC;
    }

    /* Export Menu */
    .export-menu {
        position: relative;
    }

    .export-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 8px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        border: 1px solid #E2E8F0;
        min-width: 200px;
        z-index: 1000;
        display: none;
    }

    .export-dropdown.show {
        display: block;
        animation: slideDown 0.2s ease-out;
    }

    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .export-dropdown a {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        color: #334155;
        text-decoration: none;
        font-size: 14px;
        transition: all 0.2s ease;
    }

    .export-dropdown a:hover {
        background: #F8FAFC;
        color: #139145;
    }

    .export-dropdown a i {
        font-size: 18px;
        width: 24px;
    }

    /* Responsive */
    @media (max-width: 1200px) {
        .chart-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .kpi-grid {
            grid-template-columns: 1fr;
        }

        .filter-grid {
            grid-template-columns: 1fr;
        }

        .analytics-header {
            padding: 24px 16px;
        }

        .analytics-header h1 {
            font-size: 24px;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Chart.js default configuration
    Chart.defaults.font.family = "'Inter', sans-serif";
    Chart.defaults.color = '#64748B';
    
    const wajirColors = {
        green: '#139145',
        orange: '#C18B5A',
        red: '#CD4F27',
        blue: '#3B82F6',
        purple: '#8B5CF6',
        cyan: '#06B6D4'
    };
    
    // 1. Revenue Trend Chart
    const revenueTrendData = {{ revenue_trend_data|safe }};
    if (document.getElementById('revenueTrendChart')) {
        new Chart(document.getElementById('revenueTrendChart'), {
            type: 'line',
            data: {
                labels: revenueTrendData.labels,
                datasets: [{
                    label: 'Revenue (KES)',
                    data: revenueTrendData.data,
                    borderColor: wajirColors.green,
                    backgroundColor: 'rgba(19, 145, 69, 0.1)',
                    tension: 0.4,
                    fill: true,
                    borderWidth: 3,
                    pointRadius: 5,
                    pointBackgroundColor: wajirColors.green,
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'KES ' + context.parsed.y.toLocaleString();
                            }
                        }
                    }
                },
                scales: {
                    y: { 
                        beginAtZero: true, 
                        grid: { color: '#F1F5F9' },
                        ticks: {
                            callback: function(value) {
                                return 'KES ' + value.toLocaleString();
                            }
                        }
                    },
                    x: { grid: { display: false } }
                }
            }
        });
    }
    
    // 2. Revenue by Stream Chart
    const revenueStreamData = {{ revenue_stream_data|safe }};
    if (document.getElementById('revenueStreamChart')) {
        new Chart(document.getElementById('revenueStreamChart'), {
            type: 'doughnut',
            data: {
                labels: revenueStreamData.labels,
                datasets: [{
                    data: revenueStreamData.data,
                    backgroundColor: revenueStreamData.colors,
                    borderWidth: 0,
                    hoverOffset: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { padding: 15, font: { size: 12 } }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return label + ': KES ' + value.toLocaleString() + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });
    }
    
    // 3. Sub-County Revenue Chart
    const subcountyData = {{ subcounty_revenue_data|safe }};
    if (document.getElementById('subcountyChart')) {
        new Chart(document.getElementById('subcountyChart'), {
            type: 'bar',
            data: {
                labels: subcountyData.labels,
                datasets: [{
                    label: 'Revenue',
                    data: subcountyData.data,
                    backgroundColor: wajirColors.green,
                    borderRadius: 6,
                    hoverBackgroundColor: wajirColors.orange
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'KES ' + context.parsed.y.toLocaleString();
                            }
                        }
                    }
                },
                scales: {
                    y: { 
                        beginAtZero: true, 
                        grid: { color: '#F1F5F9' },
                        ticks: {
                            callback: function(value) {
                                return 'KES ' + value.toLocaleString();
                            }
                        }
                    },
                    x: { grid: { display: false } }
                }
            }
        });
    }
    
    // 4. Payment Methods Chart
    const paymentMethodData = {{ payment_method_data|safe }};
    if (document.getElementById('paymentMethodChart')) {
        new Chart(document.getElementById('paymentMethodChart'), {
            type: 'pie',
            data: {
                labels: paymentMethodData.labels,
                datasets: [{
                    data: paymentMethodData.data,
                    backgroundColor: paymentMethodData.colors,
                    borderWidth: 0,
                    hoverOffset: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { padding: 15, font: { size: 12 } }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const count = paymentMethodData.counts[context.dataIndex];
                                return label + ': KES ' + value.toLocaleString() + ' (' + count + ' transactions)';
                            }
                        }
                    }
                }
            }
        });
    }
    
    // 5. Bills Status Chart
    const billsStatusData = {{ bills_status_data|safe }};
    if (document.getElementById('billsStatusChart')) {
        new Chart(document.getElementById('billsStatusChart'), {
            type: 'doughnut',
            data: {
                labels: billsStatusData.labels,
                datasets: [{
                    data: billsStatusData.data,
                    backgroundColor: billsStatusData.colors,
                    borderWidth: 0,
                    hoverOffset: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { padding: 15, font: { size: 12 } }
                    }
                }
            }
        });
    }
    
    // 6. Visits Trend Chart
    const visitsTrendData = {{ visits_trend_data|safe }};
    if (document.getElementById('visitsTrendChart')) {
        new Chart(document.getElementById('visitsTrendChart'), {
            type: 'line',
            data: {
                labels: visitsTrendData.labels,
                datasets: [{
                    label: 'Patient Visits',
                    data: visitsTrendData.data,
                    borderColor: wajirColors.blue,
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4,
                    fill: true,
                    borderWidth: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true, grid: { color: '#F1F5F9' } },
                    x: { grid: { display: false } }
                }
            }
        });
    }
    
    // 7. Fuel Trend Chart
    const fuelTrendData = {{ fuel_trend_data|safe }};
    if (document.getElementById('fuelTrendChart')) {
        new Chart(document.getElementById('fuelTrendChart'), {
            type: 'bar',
            data: {
                labels: fuelTrendData.labels,
                datasets: [{
                    label: 'Fuel Cost (KES)',
                    data: fuelTrendData.data,
                    backgroundColor: wajirColors.red,
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const liters = fuelTrendData.liters[context.dataIndex];
                                return 'KES ' + context.parsed.y.toLocaleString() + ' (' + liters + ' liters)';
                            }
                        }
                    }
                },
                scales: {
                    y: { 
                        beginAtZero: true, 
                        grid: { color: '#F1F5F9' },
                        ticks: {
                            callback: function(value) {
                                return 'KES ' + value.toLocaleString();
                            }
                        }
                    },
                    x: { grid: { display: false } }
                }
            }
        });
    }
    
    // 8. License Status Chart
    const licenseStatusData = {{ license_status_data|safe }};
    if (document.getElementById('licenseStatusChart')) {
        new Chart(document.getElementById('licenseStatusChart'), {
            type: 'pie',
            data: {
                labels: licenseStatusData.labels,
                datasets: [{
                    data: licenseStatusData.data,
                    backgroundColor: licenseStatusData.colors,
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { padding: 15, font: { size: 12 } }
                    }
                }
            }
        });
    }
    
    // Tab functionality
    const tabs = document.querySelectorAll('.nav-tab');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const targetId = this.getAttribute('data-tab');
            
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(tc => tc.classList.remove('active'));
            
            this.classList.add('active');
            document.getElementById(targetId).classList.add('active');
        });
    });
    
    // Export dropdown
    const exportBtn = document.getElementById('exportBtn');
    const exportDropdown = document.getElementById('exportDropdown');
    
    if (exportBtn && exportDropdown) {
        exportBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            exportDropdown.classList.toggle('show');
        });
        
        document.addEventListener('click', function() {
            exportDropdown.classList.remove('show');
        });
    }
    
    // Ward filter based on sub-county selection
    const subCountySelect = document.getElementById('sub_county');
    const wardSelect = document.getElementById('ward');
    
    if (subCountySelect && wardSelect) {
        subCountySelect.addEventListener('change', function() {
            const subCountyId = this.value;
            if (subCountyId) {
                // Fetch wards for selected sub-county
                fetch(`/api/wards/?sub_county=${subCountyId}`)
                    .then(response => response.json())
                    .then(data => {
                        wardSelect.innerHTML = '<option value="">All Wards</option>';
                        data.forEach(ward => {
                            const option = document.createElement('option');
                            option.value = ward.id;
                            option.textContent = ward.name;
                            wardSelect.appendChild(option);
                        });
                    });
            } else {
                wardSelect.innerHTML = '<option value="">All Wards</option>';
            }
        });
    }
    
    // Auto-submit form on filter change (optional)
    const filterForm = document.getElementById('filterForm');
    const autoSubmit = document.querySelectorAll('.auto-submit');
    
    autoSubmit.forEach(element => {
        element.addEventListener('change', function() {
            // Uncomment to enable auto-submit
            // filterForm.submit();
        });
    });
});
</script>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="analytics-header">
    <h1><i class="bi bi-graph-up-arrow"></i> Advanced Analytics Dashboard</h1>
    <p>Comprehensive data analysis and insights for {{ start_date }} to {{ end_date }}</p>
</div>

<!-- Filter Panel -->
<div class="filter-panel">
    <div class="filter-header">
        <h2 class="filter-title">
            <i class="bi bi-funnel"></i>
            Filters & Date Range
        </h2>
        <div class="export-menu">
            <button class="btn btn-export" id="exportBtn">
                <i class="bi bi-download"></i>
                Export Data
            </button>
            <div class="export-dropdown" id="exportDropdown">
                <a href="?{{ request.GET.urlencode }}&export=csv&type=revenue">
                    <i class="bi bi-filetype-csv"></i>
                    Revenue Report (CSV)
                </a>
                <a href="?{{ request.GET.urlencode }}&export=excel&type=revenue">
                    <i class="bi bi-file-earmark-excel"></i>
                    Revenue Report (Excel)
                </a>
                <a href="?{{ request.GET.urlencode }}&export=csv&type=bills">
                    <i class="bi bi-filetype-csv"></i>
                    Bills Report (CSV)
                </a>
                <a href="?{{ request.GET.urlencode }}&export=excel&type=bills">
                    <i class="bi bi-file-earmark-excel"></i>
                    Bills Report (Excel)
                </a>
            </div>
        </div>
    </div>
    
    <form method="GET" id="filterForm">
        <div class="filter-grid">
            <div class="filter-group">
                <label for="date_range">Date Range</label>
                <select name="date_range" id="date_range" class="auto-submit">
                    <option value="7" {% if date_range == '7' %}selected{% endif %}>Last 7 Days</option>
                    <option value="30" {% if date_range == '30' %}selected{% endif %}>Last 30 Days</option>
                    <option value="90" {% if date_range == '90' %}selected{% endif %}>Last 90 Days</option>
                    <option value="180" {% if date_range == '180' %}selected{% endif %}>Last 6 Months</option>
                    <option value="365" {% if date_range == '365' %}selected{% endif %}>Last Year</option>
                    <option value="ytd" {% if date_range == 'ytd' %}selected{% endif %}>Year to Date</option>
                    <option value="month" {% if date_range == 'month' %}selected{% endif %}>This Month</option>
                    <option value="custom">Custom Range</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="start_date">Start Date</label>
                <input type="date" name="start_date" id="start_date" value="{{ start_date }}">
            </div>
            
            <div class="filter-group">
                <label for="end_date">End Date</label>
                <input type="date" name="end_date" id="end_date" value="{{ end_date }}">
            </div>
            
            <div class="filter-group">
                <label for="sub_county">Sub-County</label>
                <select name="sub_county" id="sub_county" class="auto-submit">
                    <option value="">All Sub-Counties</option>
                    {% for sc in sub_counties %}
                    <option value="{{ sc.id }}" {% if selected_sub_county|stringformat:"s" == sc.id|stringformat:"s" %}selected{% endif %}>
                        {{ sc.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="filter-group">
                <label for="ward">Ward</label>
                <select name="ward" id="ward" class="auto-submit">
                    <option value="">All Wards</option>
                    {% for ward in wards %}
                    <option value="{{ ward.id }}" {% if selected_ward|stringformat:"s" == ward.id|stringformat:"s" %}selected{% endif %}>
                        {{ ward.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="filter-group">
                <label for="revenue_stream">Revenue Stream</label>
                <select name="revenue_stream" id="revenue_stream" class="auto-submit">
                    <option value="">All Revenue Streams</option>
                    {% for rs in revenue_streams %}
                    <option value="{{ rs.id }}" {% if selected_revenue_stream|stringformat:"s" == rs.id|stringformat:"s" %}selected{% endif %}>
                        {{ rs.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <div class="filter-actions">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-search"></i>
                Apply Filters
            </button>
            <a href="{% url 'analytics_dashboard' %}" class="btn btn-secondary">
                <i class="bi bi-x-circle"></i>
                Clear Filters
            </a>
        </div>
    </form>
</div>

<!-- KPI Cards -->
<div class="kpi-grid">
    <!-- Total Revenue -->
    <div class="kpi-card">
        <div class="kpi-header">
            <div class="kpi-icon">
                <i class="bi bi-cash-stack"></i>
            </div>
            {% if revenue_growth > 0 %}
            <div class="kpi-trend up">
                <i class="bi bi-arrow-up"></i> {{ revenue_growth }}%
            </div>
            {% elif revenue_growth < 0 %}
            <div class="kpi-trend down">
                <i class="bi bi-arrow-down"></i> {{ revenue_growth|floatformat:1 }}%
            </div>
            {% endif %}
        </div>
        <div class="kpi-value">KES {{ total_revenue|floatformat:0|intcomma }}</div>
        <div class="kpi-label">Total Revenue Collected</div>
    </div>
    
    <!-- Total Billed -->
    <div class="kpi-card blue">
        <div class="kpi-header">
            <div class="kpi-icon">
                <i class="bi bi-receipt"></i>
            </div>
        </div>
        <div class="kpi-value">KES {{ total_billed|floatformat:0|intcomma }}</div>
        <div class="kpi-label">Total Amount Billed</div>
    </div>
    
    <!-- Outstanding -->
    <div class="kpi-card red">
        <div class="kpi-header">
            <div class="kpi-icon">
                <i class="bi bi-exclamation-triangle"></i>
            </div>
        </div>
        <div class="kpi-value">KES {{ outstanding|floatformat:0|intcomma }}</div>
        <div class="kpi-label">Outstanding Amount</div>
    </div>
    
    <!-- Collection Rate -->
    <div class="kpi-card orange">
        <div class="kpi-header">
            <div class="kpi-icon">
                <i class="bi bi-percent"></i>
            </div>
        </div>
        <div class="kpi-value">{{ collection_rate|floatformat:1 }}%</div>
        <div class="kpi-label">Collection Rate</div>
    </div>
    
    <!-- Total Bills -->
    <div class="kpi-card blue">
        <div class="kpi-header">
            <div class="kpi-icon">
                <i class="bi bi-file-text"></i>
            </div>
        </div>
        <div class="kpi-value">{{ total_bills|intcomma }}</div>
        <div class="kpi-label">Total Bills Issued</div>
    </div>
    
    <!-- Paid Bills -->
    <div class="kpi-card">
        <div class="kpi-header">
            <div class="kpi-icon">
                <i class="bi bi-check-circle"></i>
            </div>
        </div>
        <div class="kpi-value">{{ paid_bills|intcomma }}</div>
        <div class="kpi-label">Bills Fully Paid</div>
    </div>
    
    <!-- Overdue Bills -->
    <div class="kpi-card red">
        <div class="kpi-header">
            <div class="kpi-icon">
                <i class="bi bi-alarm"></i>
            </div>
        </div>
        <div class="kpi-value">{{ overdue_bills|intcomma }}</div>
        <div class="kpi-label">Overdue Bills</div>
    </div>
    
    <!-- Average Payment -->
    <div class="kpi-card orange">
        <div class="kpi-header">
            <div class="kpi-icon">
                <i class="bi bi-calculator"></i>
            </div>
        </div>
        <div class="kpi-value">KES {{ avg_payment_amount|floatformat:0|intcomma }}</div>
        <div class="kpi-label">Average Payment</div>
    </div>
</div>

<!-- Main Revenue Trend Chart (Full Width) -->
<div class="chart-card full-width">
    <div class="chart-header">
        <h3 class="chart-title">
            <i class="bi bi-graph-up"></i>
            Revenue Collection Trend
        </h3>
        <span style="font-size: 13px; color: #64748B;">{{ start_date|date:"M d, Y" }} - {{ end_date|date:"M d, Y" }}</span>
    </div>
    <div class="chart-body">
        <div class="chart-container">
            <canvas id="revenueTrendChart"></canvas>
        </div>
    </div>
</div>

<!-- Revenue Analysis Charts -->
<div class="chart-grid">
    <!-- Revenue by Stream -->
    <div class="chart-card">
        <div class="chart-header">
            <h3 class="chart-title">
                <i class="bi bi-pie-chart"></i>
                Revenue Distribution by Stream
            </h3>
        </div>
        <div class="chart-body">
            <div class="chart-container">
                <canvas id="revenueStreamChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Revenue by Sub-County -->
    <div class="chart-card">
        <div class="chart-header">
            <h3 class="chart-title">
                <i class="bi bi-map"></i>
                Top 10 Sub-Counties by Revenue
            </h3>
        </div>
        <div class="chart-body">
            <div class="chart-container">
                <canvas id="subcountyChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Payment Methods -->
    <div class="chart-card">
        <div class="chart-header">
            <h3 class="chart-title">
                <i class="bi bi-credit-card"></i>
                Revenue by Payment Method
            </h3>
        </div>
        <div class="chart-body">
            <div class="chart-container">
                <canvas id="paymentMethodChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Bills Status -->
    <div class="chart-card">
        <div class="chart-header">
            <h3 class="chart-title">
                <i class="bi bi-file-earmark-check"></i>
                Bills Status Distribution
            </h3>
        </div>
        <div class="chart-body">
            <div class="chart-container">
                <canvas id="billsStatusChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Tabbed Content Section -->
<div class="chart-card full-width">
    <div class="nav-tabs-custom">
        <button class="nav-tab active" data-tab="health-tab">
            <i class="bi bi-hospital"></i>
            Health Services
        </button>
        <button class="nav-tab" data-tab="licenses-tab">
            <i class="bi bi-award"></i>
            Licenses & Business
        </button>
        <button class="nav-tab" data-tab="fleet-tab">
            <i class="bi bi-truck"></i>
            Fleet Management
        </button>
        <button class="nav-tab" data-tab="hr-tab">
            <i class="bi bi-people"></i>
            Human Resources
        </button>
        <button class="nav-tab" data-tab="performance-tab">
            <i class="bi bi-trophy"></i>
            Performance Metrics
        </button>
    </div>
    
    <!-- Health Services Tab -->
    <div class="tab-content active" id="health-tab">
        <div style="padding: 24px;">
            <!-- Health KPIs -->
            <div class="kpi-grid" style="margin-bottom: 30px;">
                <div class="kpi-card blue">
                    <div class="kpi-header">
                        <div class="kpi-icon">
                            <i class="bi bi-person-badge"></i>
                        </div>
                    </div>
                    <div class="kpi-value">{{ total_patients|intcomma }}</div>
                    <div class="kpi-label">Total Registered Patients</div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-icon">
                            <i class="bi bi-clipboard-pulse"></i>
                        </div>
                    </div>
                    <div class="kpi-value">{{ total_visits|intcomma }}</div>
                    <div class="kpi-label">Patient Visits (Period)</div>
                </div>
                
                <div class="kpi-card orange">
                    <div class="kpi-header">
                        <div class="kpi-icon">
                            <i class="bi bi-calculator"></i>
                        </div>
                    </div>
                    <div class="kpi-value">
                        {% if total_patients > 0 %}
                            {{ total_visits|floatformat:0|default:"0" }}
                        {% else %}
                            0
                        {% endif %}
                    </div>
                    <div class="kpi-label">Avg Visits per Day</div>
                </div>
            </div>
            
            <!-- Health Charts -->
            <div class="chart-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">
                            <i class="bi bi-graph-up"></i>
                            Patient Visits Trend
                        </h3>
                    </div>
                    <div class="chart-body">
                        <div class="chart-container">
                            <canvas id="visitsTrendChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Licenses & Business Tab -->
    <div class="tab-content" id="licenses-tab">
        <div style="padding: 24px;">
            <!-- License KPIs -->
            <div class="kpi-grid" style="margin-bottom: 30px;">
                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-icon">
                            <i class="bi bi-award"></i>
                        </div>
                    </div>
                    <div class="kpi-value">{{ total_licenses|intcomma }}</div>
                    <div class="kpi-label">Active Licenses</div>
                </div>
                
                <div class="kpi-card orange">
                    <div class="kpi-header">
                        <div class="kpi-icon">
                            <i class="bi bi-calendar-event"></i>
                        </div>
                    </div>
                    <div class="kpi-value">{{ expiring_licenses|intcomma }}</div>
                    <div class="kpi-label">Expiring Soon (30 Days)</div>
                </div>
                
                <div class="kpi-card blue">
                    <div class="kpi-header">
                        <div class="kpi-icon">
                            <i class="bi bi-plus-circle"></i>
                        </div>
                    </div>
                    <div class="kpi-value">{{ licenses_issued|intcomma }}</div>
                    <div class="kpi-label">Licenses Issued (Period)</div>
                </div>
            </div>
            
            <!-- License Charts -->
            <div class="chart-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">
                            <i class="bi bi-pie-chart"></i>
                            License Status Distribution
                        </h3>
                    </div>
                    <div class="chart-body">
                        <div class="chart-container">
                            <canvas id="licenseStatusChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Fleet Management Tab -->
    <div class="tab-content" id="fleet-tab">
        <div style="padding: 24px;">
            <!-- Fleet KPIs -->
            <div class="kpi-grid" style="margin-bottom: 30px;">
                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-icon">
                            <i class="bi bi-truck"></i>
                        </div>
                    </div>
                    <div class="kpi-value">{{ active_vehicles|intcomma }}</div>
                    <div class="kpi-label">Active Vehicles</div>
                </div>
                
                <div class="kpi-card red">
                    <div class="kpi-header">
                        <div class="kpi-icon">
                            <i class="bi bi-fuel-pump"></i>
                        </div>
                    </div>
                    <div class="kpi-value">KES {{ total_fuel_cost|floatformat:0|intcomma }}</div>
                    <div class="kpi-label">Total Fuel Cost (Period)</div>
                </div>
                
                <div class="kpi-card orange">
                    <div class="kpi-header">
                        <div class="kpi-icon">
                            <i class="bi bi-droplet"></i>
                        </div>
                    </div>
                    <div class="kpi-value">{{ total_fuel_liters|floatformat:0|intcomma }}</div>
                    <div class="kpi-label">Total Liters Consumed</div>
                </div>
            </div>
            
            <!-- Fuel Charts -->
            <div class="chart-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">
                            <i class="bi bi-bar-chart"></i>
                            Fuel Cost Trend
                        </h3>
                    </div>
                    <div class="chart-body">
                        <div class="chart-container">
                            <canvas id="fuelTrendChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Human Resources Tab -->
    <div class="tab-content" id="hr-tab">
        <div style="padding: 24px;">
            <!-- HR KPIs -->
            <div class="kpi-grid" style="margin-bottom: 30px;">
                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-icon">
                            <i class="bi bi-people"></i>
                        </div>
                    </div>
                    <div class="kpi-value">{{ total_employees|intcomma }}</div>
                    <div class="kpi-label">Total Employees</div>
                </div>
                
                <div class="kpi-card blue">
                    <div class="kpi-header">
                        <div class="kpi-icon">
                            <i class="bi bi-person-check"></i>
                        </div>
                    </div>
                    <div class="kpi-value">{{ total_attendance|intcomma }}</div>
                    <div class="kpi-label">Unique Attendances (Period)</div>
                </div>
                
                <div class="kpi-card orange">
                    <div class="kpi-header">
                        <div class="kpi-icon">
                            <i class="bi bi-percent"></i>
                        </div>
                    </div>
                    <div class="kpi-value">
                        {% if total_employees > 0 %}
                            {% widthratio total_attendance total_employees 100 %}%
                        {% else %}
                            0%
                        {% endif %}
                    </div>
                    <div class="kpi-label">Attendance Rate</div>
                </div>
            </div>
            
            <div class="alert-box info">
                <i class="bi bi-info-circle" style="font-size: 24px;"></i>
                <div>
                    <strong>HR Insights:</strong> Employee attendance and leave management data for the selected period.
                </div>
            </div>
        </div>
    </div>
    
    <!-- Performance Metrics Tab -->
    <div class="tab-content" id="performance-tab">
        <div style="padding: 24px;">
            <h3 style="font-size: 18px; font-weight: 600; color: #1E293B; margin-bottom: 24px;">
                <i class="bi bi-trophy" style="color: #139145;"></i>
                Top Performing Revenue Streams
            </h3>
            
            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Revenue Stream</th>
                            <th>Code</th>
                            <th>Total Revenue</th>
                            <th>Transactions</th>
                            <th>Avg Transaction</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for stream in top_revenue_streams %}
                        <tr>
                            <td>
                                <span style="display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; border-radius: 50%; background: rgba(19, 145, 69, 0.1); color: #139145; font-weight: 700;">
                                    {{ forloop.counter }}
                                </span>
                            </td>
                            <td style="font-weight: 600;">{{ stream.revenue_stream__name }}</td>
                            <td>
                                <span style="font-family: monospace; background: #F8FAFC; padding: 4px 8px; border-radius: 4px;">
                                    {{ stream.revenue_stream__code }}
                                </span>
                            </td>
                            <td style="font-weight: 700; color: #139145;">
                                KES {{ stream.revenue|floatformat:0|intcomma }}
                            </td>
                            <td>{{ stream.count|intcomma }}</td>
                            <td>
                                {% if stream.count > 0 %}
                                    KES {% widthratio stream.revenue stream.count 1 %}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 48px; color: #64748B;">
                                <i class="bi bi-inbox" style="font-size: 48px; display: block; margin-bottom: 16px; color: #CBD5E1;"></i>
                                No data available for selected period
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Additional Metrics -->
            <div class="kpi-grid" style="margin-top: 32px;">
                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-icon">
                            <i class="bi bi-person-circle"></i>
                        </div>
                    </div>
                    <div class="kpi-value">KES {{ revenue_per_citizen|floatformat:0|intcomma }}</div>
                    <div class="kpi-label">Revenue per Citizen</div>
                </div>
                
                <div class="kpi-card blue">
                    <div class="kpi-header">
                        <div class="kpi-icon">
                            <i class="bi bi-receipt"></i>
                        </div>
                    </div>
                    <div class="kpi-value">KES {{ avg_bill_amount|floatformat:0|intcomma }}</div>
                    <div class="kpi-label">Average Bill Amount</div>
                </div>
                
                <div class="kpi-card orange">
                    <div class="kpi-header">
                        <div class="kpi-icon">
                            <i class="bi bi-piggy-bank"></i>
                        </div>
                    </div>
                    <div class="kpi-value">{{ total_citizens|intcomma }}</div>
                    <div class="kpi-label">Total Citizens</div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-icon">
                            <i class="bi bi-building"></i>
                        </div>
                    </div>
                    <div class="kpi-value">{{ total_properties|intcomma }}</div>
                    <div class="kpi-label">Registered Properties</div>
                </div>
            </div>
        </div>
    </div>
</div>



{% endblock %}