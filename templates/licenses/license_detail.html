{% extends 'admin_base.html' %}
{% load custom_filter %}
{% load humanize %}
{% load static %}

{% block title %}License Details - {{ license.license_number }}{% endblock %}

{% block extra_css %}
<style>
    .breadcrumb {
        padding: 0;
        margin-bottom: 20px;
        font-size: 14px;
        list-style: none;
        display: flex;
        flex-wrap: wrap;
    }

    .breadcrumb-item {
        color: #64748B;
    }

    .breadcrumb-item + .breadcrumb-item::before {
        content: "/ ";
        color: #94A3B8;
        padding: 0 8px;
    }

    .breadcrumb-item.active {
        color: #1E293B;
        font-weight: 500;
    }

    .breadcrumb a {
        color: #3498db;
        text-decoration: none;
        transition: color 0.3s ease;
    }

    .page-header {
        background: white;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border-left: 4px solid #667eea;
    }

    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: start;
        flex-wrap: wrap;
        gap: 20px;
    }

    .header-left {
        flex: 1;
    }

    .license-number {
        font-size: 28px;
        font-weight: 700;
        color: #1E293B;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .license-icon {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 24px;
    }

    .business-name {
        font-size: 18px;
        color: #64748B;
        margin-bottom: 12px;
    }

    .header-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        font-size: 14px;
        color: #64748B;
    }

    .meta-item {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .meta-item i {
        color: #94A3B8;
    }

    .header-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .btn-action {
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border: none;
    }

    .btn-primary {
        background: #667eea;
        color: white;
    }

    .btn-primary:hover {
        background: #5568d3;
        color: white;
    }

    .btn-success {
        background: #10b981;
        color: white;
    }

    .btn-success:hover {
        background: #059669;
        color: white;
    }

    .btn-warning {
        background: #f59e0b;
        color: white;
    }

    .btn-warning:hover {
        background: #d97706;
        color: white;
    }

    .btn-danger {
        background: #ef4444;
        color: white;
    }

    .btn-danger:hover {
        background: #dc2626;
        color: white;
    }

    .btn-outline {
        background: white;
        color: #64748B;
        border: 1px solid #E2E8F0;
    }

    .btn-outline:hover {
        background: #F8FAFC;
        border-color: #CBD5E1;
        color: #64748B;
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .status-draft {
        background: #F3F4F6;
        color: #6B7280;
    }

    .status-submitted {
        background: #DBEAFE;
        color: #1E40AF;
    }

    .status-under_review,
    .status-under-review {
        background: #FEF3C7;
        color: #92400E;
    }

    .status-approved {
        background: #D1FAE5;
        color: #065F46;
    }

    .status-active {
        background: #D1FAE5;
        color: #065F46;
    }

    .status-rejected {
        background: #FEE2E2;
        color: #991B1B;
    }

    .status-expired {
        background: #FEE2E2;
        color: #991B1B;
    }

    .status-issued {
        background: #E0E7FF;
        color: #3730A3;
    }

    .status-suspended {
        background: #FEF3C7;
        color: #92400E;
    }

    .status-revoked {
        background: #FEE2E2;
        color: #991B1B;
    }

    .alert-banner {
        padding: 16px 20px;
        border-radius: 8px;
        margin-bottom: 24px;
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 14px;
        font-weight: 500;
    }

    .alert-warning {
        background: #FEF3C7;
        color: #92400E;
        border-left: 4px solid #f59e0b;
    }

    .alert-danger {
        background: #FEE2E2;
        color: #991B1B;
        border-left: 4px solid #ef4444;
    }

    .alert-info {
        background: #DBEAFE;
        color: #1E40AF;
        border-left: 4px solid #3b82f6;
    }

    .content-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 24px;
        margin-bottom: 24px;
    }

    .section-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 2px solid #F1F5F9;
    }

    .section-title {
        font-size: 18px;
        font-weight: 700;
        color: #1E293B;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
    }

    .info-item {
        padding: 16px;
        background: #F8FAFC;
        border-radius: 8px;
        border-left: 3px solid #667eea;
    }

    .info-label {
        font-size: 12px;
        font-weight: 600;
        color: #64748B;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 6px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .info-value {
        font-size: 15px;
        font-weight: 600;
        color: #1E293B;
    }

    .timeline {
        position: relative;
        padding-left: 30px;
    }

    .timeline::before {
        content: "";
        position: absolute;
        left: 8px;
        top: 8px;
        bottom: 8px;
        width: 2px;
        background: #E2E8F0;
    }

    .timeline-item {
        position: relative;
        padding-bottom: 24px;
    }

    .timeline-item:last-child {
        padding-bottom: 0;
    }

    .timeline-marker {
        position: absolute;
        left: -26px;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: white;
        border: 3px solid #667eea;
    }

    .timeline-marker.success {
        border-color: #10b981;
    }

    .timeline-marker.warning {
        border-color: #f59e0b;
    }

    .timeline-marker.danger {
        border-color: #ef4444;
    }

    .timeline-content {
        background: #F8FAFC;
        padding: 12px 16px;
        border-radius: 8px;
    }

    .timeline-title {
        font-size: 14px;
        font-weight: 600;
        color: #1E293B;
        margin-bottom: 4px;
    }

    .timeline-meta {
        font-size: 12px;
        color: #64748B;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .timeline-date {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .documents-list {
        display: grid;
        gap: 12px;
    }

    .document-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px;
        background: #F8FAFC;
        border-radius: 8px;
        transition: all 0.3s ease;
        border: 1px solid #E2E8F0;
    }

    .document-item:hover {
        background: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .document-info {
        display: flex;
        align-items: center;
        gap: 12px;
        flex: 1;
    }

    .document-icon {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 18px;
    }

    .document-details {
        flex: 1;
    }

    .document-name {
        font-size: 14px;
        font-weight: 600;
        color: #1E293B;
        margin-bottom: 2px;
    }

    .document-meta {
        font-size: 12px;
        color: #64748B;
    }

    .document-actions {
        display: flex;
        gap: 8px;
    }

    .btn-icon {
        width: 36px;
        height: 36px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #E2E8F0;
        background: white;
        color: #64748B;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
    }

    .btn-icon:hover {
        background: #F8FAFC;
        border-color: #667eea;
        color: #667eea;
    }

    .renewal-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background: #E0E7FF;
        color: #3730A3;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
    }

    .summary-box {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 12px;
        padding: 24px;
        color: white;
        margin-bottom: 24px;
    }

    .summary-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    .summary-item:last-child {
        border-bottom: none;
    }

    .summary-label {
        font-size: 14px;
        opacity: 0.9;
    }

    .summary-value {
        font-size: 16px;
        font-weight: 700;
    }

    .expiry-countdown {
        text-align: center;
        padding: 24px;
        background: #F8FAFC;
        border-radius: 12px;
        margin-bottom: 20px;
    }

    .countdown-value {
        font-size: 48px;
        font-weight: 700;
        color: #1E293B;
        line-height: 1;
        margin-bottom: 8px;
    }

    .countdown-value.warning {
        color: #f59e0b;
    }

    .countdown-value.danger {
        color: #ef4444;
    }

    .countdown-label {
        font-size: 14px;
        font-weight: 600;
        color: #64748B;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .empty-state {
        text-align: center;
        padding: 40px 20px;
    }

    .empty-icon {
        font-size: 48px;
        color: #CBD5E1;
        margin-bottom: 12px;
    }

    .empty-title {
        font-size: 16px;
        font-weight: 600;
        color: #64748B;
        margin-bottom: 8px;
    }

    .empty-text {
        font-size: 14px;
        color: #94A3B8;
    }

    @media print {
        .header-actions,
        .btn-action,
        .breadcrumb {
            display: none !important;
        }
    }

    @media (max-width: 1024px) {
        .content-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .header-content {
            flex-direction: column;
        }

        .header-actions {
            width: 100%;
        }

        .btn-action {
            flex: 1;
            justify-content: center;
        }

        .info-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{% url 'admin_dashboard' %}">
                    <i class="bi bi-house-door"></i> Dashboard
                </a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'licenses_dashboard' %}">Licenses & Permits</a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'license_list' %}">All Licenses</a>
            </li>
            <li class="breadcrumb-item active">{{ license.license_number }}</li>
        </ol>
    </nav>

    <!-- Alert Banners -->
    {% if license.status == 'expired' %}
    <div class="alert-banner alert-danger">
        <i class="fas fa-exclamation-circle" style="font-size: 20px;"></i>
        <div>
            <strong>Expired License:</strong> This license expired on {{ license.expiry_date|date:"F d, Y" }}. 
            Renewal is required to continue operations.
        </div>
    </div>
    {% elif days_to_expiry and days_to_expiry <= 30 and days_to_expiry > 0 %}
    <div class="alert-banner alert-warning">
        <i class="fas fa-exclamation-triangle" style="font-size: 20px;"></i>
        <div>
            <strong>Expiring Soon:</strong> This license will expire in {{ days_to_expiry }} day{{ days_to_expiry|pluralize }}. 
            Please initiate renewal process.
        </div>
    </div>
    {% endif %}

    {% if license.status == 'submitted' or license.status == 'under_review' %}
    <div class="alert-banner alert-info">
        <i class="fas fa-info-circle" style="font-size: 20px;"></i>
        <div>
            <strong>Application Under Review:</strong> This application is currently being processed. 
            Average processing time is {{ avg_processing_time|default:"7-14" }} days.
        </div>
    </div>
    {% endif %}

    <!-- Page Header -->
    <div class="page-header">
        <div class="header-content">
            <div class="header-left">
                <div class="license-number">
                    <div class="license-icon">
                        <i class="fas fa-certificate"></i>
                    </div>
                    <span>{{ license.license_number }}</span>
                    {% if license.is_renewal %}
                    <span class="renewal-badge">
                        <i class="bi bi-arrow-repeat"></i>
                        Renewal
                    </span>
                    {% endif %}
                </div>
                <div class="business-name">
                    <i class="bi bi-building"></i> {{ license.business.business_name }}
                </div>
                <div class="header-meta">
                    <div class="meta-item">
                        <i class="bi bi-tag"></i>
                        <strong>Type:</strong> {{ license.license_type.name }}
                    </div>
                    <div class="meta-item">
                        <i class="bi bi-calendar"></i>
                        <strong>Applied:</strong> {{ license.application_date|date:"M d, Y" }}
                    </div>
                    <div class="meta-item">
                        <span class="status-badge status-{{ license.status }}">
                            {{ license.get_status_display }}
                        </span>
                    </div>
                </div>
            </div>

            <div class="header-actions">
                <a href="{% url 'license_update' license.pk %}" class="btn-action btn-warning">
                    <i class="bi bi-pencil"></i>
                    Edit
                </a>
                <button onclick="window.print()" class="btn-action btn-outline">
                    <i class="bi bi-printer"></i>
                    Print
                </button>
                <a href="{% url 'license_list' %}" class="btn-action btn-outline">
                    <i class="bi bi-arrow-left"></i>
                    Back to List
                </a>
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="content-grid">
        <!-- Left Column -->
        <div>
            <!-- Business Information -->
            <div class="section-card">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="bi bi-building"></i>
                        Business Information
                    </h3>
                </div>

                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">
                            <i class="bi bi-building"></i>
                            Business Name
                        </div>
                        <div class="info-value">{{ license.business.business_name }}</div>
                    </div>

                    {% if license.business.trading_name %}
                    <div class="info-item">
                        <div class="info-label">
                            <i class="bi bi-tag"></i>
                            Trading Name
                        </div>
                        <div class="info-value">{{ license.business.trading_name }}</div>
                    </div>
                    {% endif %}

                    <div class="info-item">
                        <div class="info-label">
                            <i class="bi bi-hash"></i>
                            Business Number
                        </div>
                        <div class="info-value">{{ license.business.business_number }}</div>
                    </div>

                    <div class="info-item">
                        <div class="info-label">
                            <i class="bi bi-diagram-3"></i>
                            Category
                        </div>
                        <div class="info-value">{{ license.business.business_category.name }}</div>
                    </div>

                    <div class="info-item">
                        <div class="info-label">
                            <i class="bi bi-geo-alt"></i>
                            Sub-County
                        </div>
                        <div class="info-value">{{ license.business.sub_county.name }}</div>
                    </div>

                    <div class="info-item">
                        <div class="info-label">
                            <i class="bi bi-map"></i>
                            Ward
                        </div>
                        <div class="info-value">{{ license.business.ward.name }}</div>
                    </div>

                    <div class="info-item" style="grid-column: 1 / -1;">
                        <div class="info-label">
                            <i class="bi bi-pin-map"></i>
                            Physical Address
                        </div>
                        <div class="info-value">{{ license.business.physical_address }}</div>
                    </div>

                    <div class="info-item">
                        <div class="info-label">
                            <i class="bi bi-telephone"></i>
                            Phone
                        </div>
                        <div class="info-value">{{ license.business.phone }}</div>
                    </div>

                    {% if license.business.email %}
                    <div class="info-item">
                        <div class="info-label">
                            <i class="bi bi-envelope"></i>
                            Email
                        </div>
                        <div class="info-value">{{ license.business.email }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Owner Information -->
            <div class="section-card" style="margin-top: 24px;">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="bi bi-person"></i>
                        Owner Information
                    </h3>
                </div>

                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">
                            <i class="bi bi-person-badge"></i>
                            {% if license.business.citizen.entity_type == 'individual' %}
                            Full Name
                            {% else %}
                            Entity Name
                            {% endif %}
                        </div>
                        <div class="info-value">
                            {% if license.business.citizen.entity_type == 'individual' %}
                                {{ license.business.citizen.first_name }} {{ license.business.citizen.last_name }}
                            {% else %}
                                {{ license.business.citizen.business_name }}
                            {% endif %}
                        </div>
                    </div>

                    <div class="info-item">
                        <div class="info-label">
                            <i class="bi bi-hash"></i>
                            Unique Identifier
                        </div>
                        <div class="info-value">{{ license.business.citizen.unique_identifier }}</div>
                    </div>

                    <div class="info-item">
                        <div class="info-label">
                            <i class="bi bi-telephone"></i>
                            Phone
                        </div>
                        <div class="info-value">{{ license.business.citizen.phone_primary }}</div>
                    </div>

                    {% if license.business.citizen.email %}
                    <div class="info-item">
                        <div class="info-label">
                            <i class="bi bi-envelope"></i>
                            Email
                        </div>
                        <div class="info-value">{{ license.business.citizen.email }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- License Details -->
            <div class="section-card" style="margin-top: 24px;">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="bi bi-file-text"></i>
                        License Details
                    </h3>
                </div>

                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">
                            <i class="bi bi-tag"></i>
                            License Type
                        </div>
                        <div class="info-value">{{ license.license_type.name }}</div>
                    </div>

                    <div class="info-item">
                        <div class="info-label">
                            <i class="bi bi-clock-history"></i>
                            Validity Period
                        </div>
                        <div class="info-value">{{ license.license_type.validity_period_days }} days</div>
                    </div>

                    <div class="info-item">
                        <div class="info-label">
                            <i class="bi bi-calendar-check"></i>
                            Application Date
                        </div>
                        <div class="info-value">{{ license.application_date|date:"F d, Y" }}</div>
                    </div>

                    {% if license.approval_date %}
                    <div class="info-item">
                        <div class="info-label">
                            <i class="bi bi-check-circle"></i>
                            Approval Date
                        </div>
                        <div class="info-value">{{ license.approval_date|date:"F d, Y" }}</div>
                    </div>
                    {% endif %}

                    {% if license.issue_date %}
                    <div class="info-item">
                        <div class="info-label">
                            <i class="bi bi-calendar-event"></i>
                            Issue Date
                        </div>
                        <div class="info-value">{{ license.issue_date|date:"F d, Y" }}</div>
                    </div>
                    {% endif %}

                    {% if license.expiry_date %}
                    <div class="info-item">
                        <div class="info-label">
                            <i class="bi bi-calendar-x"></i>
                            Expiry Date
                        </div>
                        <div class="info-value">{{ license.expiry_date|date:"F d, Y" }}</div>
                    </div>
                    {% endif %}

                    <div class="info-item">
                        <div class="info-label">
                            <i class="bi bi-check2-square"></i>
                            Provisional
                        </div>
                        <div class="info-value">
                            {% if license.is_provisional %}
                                <span class="status-badge status-warning">Yes</span>
                            {% else %}
                                <span class="status-badge status-success">No</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="info-item">
                        <div class="info-label">
                            <i class="bi bi-arrow-repeat"></i>
                            Renewal
                        </div>
                        <div class="info-value">
                            {% if license.is_renewal %}
                                <span class="status-badge status-info">Yes</span>
                            {% else %}
                                <span class="status-badge status-draft">No</span>
                            {% endif %}
                        </div>
                    </div>

                    {% if license.notes %}
                    <div class="info-item" style="grid-column: 1 / -1;">
                        <div class="info-label">
                            <i class="bi bi-sticky"></i>
                            Notes
                        </div>
                        <div class="info-value">{{ license.notes }}</div>
                    </div>
                    {% endif %}

                    {% if license.rejection_reason %}
                    <div class="info-item" style="grid-column: 1 / -1; border-left-color: #ef4444;">
                        <div class="info-label" style="color: #991B1B;">
                            <i class="bi bi-x-circle"></i>
                            Rejection Reason
                        </div>
                        <div class="info-value" style="color: #991B1B;">{{ license.rejection_reason }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Documents Section -->
            <div class="section-card" style="margin-top: 24px;">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="bi bi-files"></i>
                        Attached Documents
                    </h3>
                    <span class="status-badge status-info">{{ documents.count }} file{{ documents.count|pluralize }}</span>
                </div>

                {% if documents %}
                <div class="documents-list">
                    {% for document in documents %}
                    <div class="document-item">
                        <div class="document-info">
                            <div class="document-icon">
                                <i class="bi bi-file-earmark-pdf"></i>
                            </div>
                            <div class="document-details">
                                <div class="document-name">{{ document.document_name }}</div>
                                <div class="document-meta">
                                    {% if document.requirement %}
                                        {{ document.requirement.requirement_name }} â€¢ 
                                    {% endif %}
                                    Uploaded {{ document.uploaded_at|date:"M d, Y" }}
                                    {% if document.uploaded_by %}
                                        by {{ document.uploaded_by.get_full_name }}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="document-actions">
                            <a href="{{ document.file.url }}" target="_blank" class="btn-icon" title="View Document">
                                <i class="bi bi-eye"></i>
                            </a>
                            <a href="{{ document.file.url }}" download class="btn-icon" title="Download Document">
                                <i class="bi bi-download"></i>
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="bi bi-files"></i>
                    </div>
                    <h3 class="empty-title">No Documents Attached</h3>
                    <p class="empty-text">No documents have been uploaded for this license application.</p>
                </div>
                {% endif %}
            </div>

            <!-- Processing Timeline -->
            <div class="section-card" style="margin-top: 24px;">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="bi bi-clock-history"></i>
                        Processing Timeline
                    </h3>
                </div>

                <div class="timeline">
                    <!-- Application Submitted -->
                    <div class="timeline-item">
                        <div class="timeline-marker"></div>
                        <div class="timeline-content">
                            <div class="timeline-title">Application Submitted</div>
                            <div class="timeline-meta">
                                <span class="timeline-date">
                                    <i class="bi bi-calendar"></i>
                                    {{ license.application_date|date:"F d, Y" }}
                                </span>
                                {% if license.created_by %}
                                <span>
                                    <i class="bi bi-person"></i>
                                    {{ license.created_by.get_full_name }}
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Under Review -->
                    {% if license.status in 'under_review,approved,rejected,active,issued' %}
                    <div class="timeline-item">
                        <div class="timeline-marker {% if license.status == 'under_review' %}warning{% else %}success{% endif %}"></div>
                        <div class="timeline-content">
                            <div class="timeline-title">Under Review</div>
                            <div class="timeline-meta">
                                {% if license.reviewed_by %}
                                <span>
                                    <i class="bi bi-person"></i>
                                    {{ license.reviewed_by.get_full_name }}
                                </span>
                                {% else %}
                                <span class="timeline-date">
                                    <i class="bi bi-clock"></i>
                                    In Progress
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Approved -->
                    {% if license.approval_date and license.status != 'rejected' %}
                    <div class="timeline-item">
                        <div class="timeline-marker success"></div>
                        <div class="timeline-content">
                            <div class="timeline-title">Application Approved</div>
                            <div class="timeline-meta">
                                <span class="timeline-date">
                                    <i class="bi bi-calendar"></i>
                                    {{ license.approval_date|date:"F d, Y" }}
                                </span>
                                {% if license.approved_by %}
                                <span>
                                    <i class="bi bi-person"></i>
                                    {{ license.approved_by.get_full_name }}
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Rejected -->
                    {% if license.status == 'rejected' %}
                    <div class="timeline-item">
                        <div class="timeline-marker danger"></div>
                        <div class="timeline-content">
                            <div class="timeline-title">Application Rejected</div>
                            <div class="timeline-meta">
                                {% if license.approved_by %}
                                <span>
                                    <i class="bi bi-person"></i>
                                    {{ license.approved_by.get_full_name }}
                                </span>
                                {% endif %}
                            </div>
                            {% if license.rejection_reason %}
                            <div style="margin-top: 8px; padding: 8px; background: #FEE2E2; border-radius: 4px; font-size: 13px; color: #991B1B;">
                                <strong>Reason:</strong> {{ license.rejection_reason }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- License Issued -->
                    {% if license.issue_date %}
                    <div class="timeline-item">
                        <div class="timeline-marker success"></div>
                        <div class="timeline-content">
                            <div class="timeline-title">License Issued</div>
                            <div class="timeline-meta">
                                <span class="timeline-date">
                                    <i class="bi bi-calendar"></i>
                                    {{ license.issue_date|date:"F d, Y" }}
                                </span>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Expiry -->
                    {% if license.expiry_date %}
                    <div class="timeline-item">
                        <div class="timeline-marker {% if license.status == 'expired' %}danger{% elif days_to_expiry and days_to_expiry <= 30 %}warning{% endif %}"></div>
                        <div class="timeline-content">
                            <div class="timeline-title">
                                {% if license.status == 'expired' %}
                                    License Expired
                                {% else %}
                                    Expires On
                                {% endif %}
                            </div>
                            <div class="timeline-meta">
                                <span class="timeline-date">
                                    <i class="bi bi-calendar"></i>
                                    {{ license.expiry_date|date:"F d, Y" }}
                                </span>
                                {% if days_to_expiry and days_to_expiry > 0 %}
                                <span style="color: {% if days_to_expiry <= 30 %}#f59e0b{% else %}#10b981{% endif %};">
                                    <i class="bi bi-hourglass-split"></i>
                                    {{ days_to_expiry }} day{{ days_to_expiry|pluralize }} remaining
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Right Column (Sidebar) -->
        <div>
            <!-- Quick Summary -->
            <div class="summary-box">
                <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                    <i class="bi bi-info-circle"></i>
                    Quick Summary
                </h3>

                <div class="summary-item">
                    <span class="summary-label">
                        <i class="bi bi-hash"></i>
                        License Number
                    </span>
                    <span class="summary-value">{{ license.license_number }}</span>
                </div>

                <div class="summary-item">
                    <span class="summary-label">
                        <i class="bi bi-card-checklist"></i>
                        Status
                    </span>
                    <span class="summary-value">{{ license.get_status_display }}</span>
                </div>

                <div class="summary-item">
                    <span class="summary-label">
                        <i class="bi bi-calendar"></i>
                        Applied
                    </span>
                    <span class="summary-value">{{ license.application_date|date:"M d, Y" }}</span>
                </div>

                {% if license.expiry_date %}
                <div class="summary-item">
                    <span class="summary-label">
                        <i class="bi bi-calendar-x"></i>
                        Expires
                    </span>
                    <span class="summary-value">{{ license.expiry_date|date:"M d, Y" }}</span>
                </div>
                {% endif %}
            </div>

            <!-- Expiry Countdown -->
            {% if license.expiry_date and license.status == 'active' %}
            <div class="section-card">
                <div class="expiry-countdown">
                    {% if days_to_expiry > 0 %}
                        <div class="countdown-value {% if days_to_expiry <= 7 %}danger{% elif days_to_expiry <= 30 %}warning{% endif %}">
                            {{ days_to_expiry }}
                        </div>
                        <div class="countdown-label">
                            Day{{ days_to_expiry|pluralize }} Until Expiry
                        </div>
                    {% elif days_to_expiry == 0 %}
                        <div class="countdown-value danger">
                            TODAY
                        </div>
                        <div class="countdown-label">
                            License Expires Today
                        </div>
                    {% else %}
                        <div class="countdown-value danger">
                            EXPIRED
                        </div>
                        <div class="countdown-label">
                            {{ days_to_expiry|abs }} Day{{ days_to_expiry|abs|pluralize }} Ago
                        </div>
                    {% endif %}
                </div>

                {% if days_to_expiry and days_to_expiry <= 90 %}
                <a href="{% url 'license_create' %}?renewal={{ license.pk }}" class="btn-action btn-success" style="width: 100%; justify-content: center;">
                    <i class="bi bi-arrow-repeat"></i>
                    Start Renewal Process
                </a>
                {% endif %}
            </div>
            {% endif %}

            <!-- Actions Card -->
            <div class="section-card" style="margin-top: 24px;">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="bi bi-lightning"></i>
                        Quick Actions
                    </h3>
                </div>

                <div style="display: grid; gap: 10px;">
                    {% if license.status in 'submitted,under_review' %}
                    <button class="btn-action btn-success" style="width: 100%; justify-content: center;" onclick="approveLicense()">
                        <i class="bi bi-check-circle"></i>
                        Approve License
                    </button>
                    
                    <button class="btn-action btn-danger" style="width: 100%; justify-content: center;" onclick="rejectLicense()">
                        <i class="bi bi-x-circle"></i>
                        Reject Application
                    </button>
                    {% endif %}

                    {% if license.status == 'approved' %}
                    <button class="btn-action btn-primary" style="width: 100%; justify-content: center;" onclick="issueLicense()">
                        <i class="bi bi-file-earmark-check"></i>
                        Issue License
                    </button>
                    {% endif %}

                    <a href="{% url 'license_update' license.pk %}" class="btn-action btn-warning" style="width: 100%; justify-content: center;">
                        <i class="bi bi-pencil"></i>
                        Edit Details
                    </a>

                    <button class="btn-action btn-outline" style="width: 100%; justify-content: center;" onclick="window.print()">
                        <i class="bi bi-printer"></i>
                        Print License
                    </button>

                    <button class="btn-action btn-outline" style="width: 100%; justify-content: center;" onclick="downloadPDF()">
                        <i class="bi bi-file-pdf"></i>
                        Download PDF
                    </button>

                    {% if license.expiry_date and days_to_expiry and days_to_expiry <= 90 %}
                    <a href="{% url 'license_create' %}?renewal={{ license.pk }}" class="btn-action btn-success" style="width: 100%; justify-content: center;">
                        <i class="bi bi-arrow-repeat"></i>
                        Renew License
                    </a>
                    {% endif %}

                    <button class="btn-action btn-danger" style="width: 100%; justify-content: center;" onclick="confirmDelete()">
                        <i class="bi bi-trash"></i>
                        Delete License
                    </button>
                </div>
            </div>

            <!-- Related Information -->
            <div class="section-card" style="margin-top: 24px;">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="bi bi-link-45deg"></i>
                        Related Information
                    </h3>
                </div>

                <div style="display: grid; gap: 12px;">
                    <a href="{% url 'business_detail' license.business.pk %}" class="info-item" style="display: block; text-decoration: none; margin: 0;">
                        <div class="info-label">
                            <i class="bi bi-building"></i>
                            View Business Details
                        </div>
                        <div class="info-value" style="color: #667eea;">
                            {{ license.business.business_name }}
                            <i class="bi bi-arrow-right"></i>
                        </div>
                    </a>

                    {% if license.business.citizen %}
                    <a href="{% url 'citizen_detail' license.business.citizen.pk %}" class="info-item" style="display: block; text-decoration: none; margin: 0;">
                        <div class="info-label">
                            <i class="bi bi-person"></i>
                            View Owner Profile
                        </div>
                        <div class="info-value" style="color: #667eea;">
                            {% if license.business.citizen.entity_type == 'individual' %}
                                {{ license.business.citizen.first_name }} {{ license.business.citizen.last_name }}
                            {% else %}
                                {{ license.business.citizen.business_name }}
                            {% endif %}
                            <i class="bi bi-arrow-right"></i>
                        </div>
                    </a>
                    {% endif %}

                    {% if license.previous_license %}
                    <a href="{% url 'license_detail' license.previous_license.pk %}" class="info-item" style="display: block; text-decoration: none; margin: 0;">
                        <div class="info-label">
                            <i class="bi bi-arrow-counterclockwise"></i>
                            Previous License
                        </div>
                        <div class="info-value" style="color: #667eea;">
                            {{ license.previous_license.license_number }}
                            <i class="bi bi-arrow-right"></i>
                        </div>
                    </a>
                    {% endif %}

                    <div class="info-item" style="margin: 0;">
                        <div class="info-label">
                            <i class="bi bi-files"></i>
                            Documents Attached
                        </div>
                        <div class="info-value">
                            {{ documents.count }} file{{ documents.count|pluralize }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Audit Information -->
            <div class="section-card" style="margin-top: 24px;">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="bi bi-shield-check"></i>
                        Audit Trail
                    </h3>
                </div>

                <div style="display: grid; gap: 8px;">
                    <div class="info-item" style="margin: 0;">
                        <div class="info-label">
                            <i class="bi bi-person-plus"></i>
                            Created By
                        </div>
                        <div class="info-value">
                            {% if license.created_by %}
                                {{ license.created_by.get_full_name }}
                            {% else %}
                                System
                            {% endif %}
                        </div>
                    </div>

                    <div class="info-item" style="margin: 0;">
                        <div class="info-label">
                            <i class="bi bi-calendar-plus"></i>
                            Created At
                        </div>
                        <div class="info-value">{{ license.created_at|date:"M d, Y g:i A" }}</div>
                    </div>

                    <div class="info-item" style="margin: 0;">
                        <div class="info-label">
                            <i class="bi bi-clock-history"></i>
                            Last Updated
                        </div>
                        <div class="info-value">{{ license.updated_at|date:"M d, Y g:i A" }}</div>
                    </div>

                    {% if license.reviewed_by %}
                    <div class="info-item" style="margin: 0;">
                        <div class="info-label">
                            <i class="bi bi-eye"></i>
                            Reviewed By
                        </div>
                        <div class="info-value">{{ license.reviewed_by.get_full_name }}</div>
                    </div>
                    {% endif %}

                    {% if license.approved_by %}
                    <div class="info-item" style="margin: 0;">
                        <div class="info-label">
                            <i class="bi bi-check-circle"></i>
                            {% if license.status == 'rejected' %}
                            Rejected By
                            {% else %}
                            Approved By
                            {% endif %}
                        </div>
                        <div class="info-value">{{ license.approved_by.get_full_name }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Approve License
    function approveLicense() {
        if (confirm('Are you sure you want to approve this license application?')) {
            // Implement approval logic
            window.location.href = "{% url 'license_approve' license.pk %}";
        }
    }

    // Reject License
    function rejectLicense() {
        const reason = prompt('Please enter the reason for rejection:');
        if (reason && reason.trim() !== '') {
            // Implement rejection logic
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = "{% url 'license_reject' license.pk %}";
            
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = '{{ csrf_token }}';
            
            const reasonInput = document.createElement('input');
            reasonInput.type = 'hidden';
            reasonInput.name = 'rejection_reason';
            reasonInput.value = reason;
            
            form.appendChild(csrfInput);
            form.appendChild(reasonInput);
            document.body.appendChild(form);
            form.submit();
        }
    }

    // Issue License
    function issueLicense() {
        if (confirm('Are you sure you want to issue this license?')) {
            // Implement license issuance logic
            window.location.href = "#";
        }
    }

    // Download PDF
    function downloadPDF() {
        // Implement PDF download logic
        window.open("#", '_blank');
    }

    // Delete License
    function confirmDelete() {
        if (confirm('Are you sure you want to delete this license? This action cannot be undone.')) {
            if (confirm('This will permanently delete license {{ license.license_number }}. Are you absolutely sure?')) {
                window.location.href = "{% url 'license_delete' license.pk %}";
            }
        }
    }

    // Print page
    window.addEventListener('beforeprint', function() {
        document.title = 'License {{ license.license_number }} - {{ license.business.business_name }}';
    });

    // Add smooth scroll behavior
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });

    // Add animation on load
    document.addEventListener('DOMContentLoaded', function() {
        const cards = document.querySelectorAll('.section-card, .summary-box');
        cards.forEach((card, index) => {
            setTimeout(() => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                card.style.transition = 'all 0.5s ease';
                
                setTimeout(() => {
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, 50);
            }, index * 100);
        });
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + P to print
        if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
            e.preventDefault();
            window.print();
        }
        // Ctrl/Cmd + E to edit
        if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
            e.preventDefault();
            window.location.href = "{% url 'license_update' license.pk %}";
        }
        // Ctrl/Cmd + D to download PDF
        if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
            e.preventDefault();
            downloadPDF();
        }
    });
</script>
{% endblock %}