{% extends 'admin_base.html' %}
{% load humanize %}
{% load static %}

{% block title %}{{ business.business_name }} - Business Details{% endblock %}

{% block extra_css %}
<style>
    .breadcrumb {
        padding: 0;
        margin-bottom: 20px;
        font-size: 14px;
        list-style: none;
        display: flex;
        flex-wrap: wrap;
    }

    .breadcrumb-item {
        color: #64748B;
    }

    .breadcrumb-item + .breadcrumb-item::before {
        content: "/ ";
        color: #94A3B8;
        padding: 0 8px;
    }

    .breadcrumb-item.active {
        color: #1E293B;
        font-weight: 500;
    }

    .breadcrumb a {
        color: #3498db;
        text-decoration: none;
        transition: color 0.3s ease;
    }

    .breadcrumb a:hover {
        color: #2980b9;
    }

    .section-container {
        background: white;
        border-radius: 8px;
        padding: 24px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        margin-bottom: 24px;
        border: 1px solid #E2E8F0;
    }

    .page-header {
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 1px solid #F1F5F9;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        flex-wrap: wrap;
        gap: 16px;
    }

    .header-left {
        flex: 1;
    }

    .business-header-info {
        display: flex;
        align-items: flex-start;
        gap: 20px;
        margin-bottom: 16px;
    }

    .business-icon-large {
        width: 72px;
        height: 72px;
        background: linear-gradient(135deg, #3498db, #2980b9);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 32px;
        color: white;
        flex-shrink: 0;
    }

    .business-header-details {
        flex: 1;
    }

    .page-title {
        font-size: 24px;
        font-weight: 600;
        color: #1E293B;
        margin-bottom: 8px;
    }

    .business-meta-row {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-top: 12px;
    }

    .meta-item {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #64748B;
        font-size: 14px;
    }

    .meta-item i {
        color: #3498db;
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .status-active {
        background: #D1FAE5;
        color: #065F46;
    }

    .status-inactive {
        background: #FEE2E2;
        color: #991B1B;
    }

    .header-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    .btn-primary, .btn-secondary, .btn-danger {
        padding: 10px 20px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border: none;
    }

    .btn-primary {
        background: #3498db;
        color: white;
        border: 1px solid #3498db;
    }

    .btn-primary:hover {
        background: #2980b9;
        color: white;
    }

    .btn-secondary {
        background: white;
        color: #64748B;
        border: 1px solid #E2E8F0;
    }

    .btn-secondary:hover {
        background: #F8FAFC;
        color: #64748B;
    }

    .btn-danger {
        background: #e74c3c;
        color: white;
        border: 1px solid #e74c3c;
    }

    .btn-danger:hover {
        background: #c0392b;
    }

    .details-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 24px;
        margin-bottom: 24px;
    }

    .detail-card {
        background: white;
        border: 1px solid #E2E8F0;
        border-radius: 8px;
        padding: 20px;
    }

    .detail-card-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid #F1F5F9;
    }

    .detail-card-icon {
        width: 36px;
        height: 36px;
        background: rgba(52, 152, 219, 0.1);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #3498db;
        font-size: 16px;
    }

    .detail-card-title {
        font-size: 16px;
        font-weight: 600;
        color: #1E293B;
    }

    .detail-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 12px 0;
        border-bottom: 1px solid #F8FAFC;
    }

    .detail-row:last-child {
        border-bottom: none;
        padding-bottom: 0;
    }

    .detail-row:first-child {
        padding-top: 0;
    }

    .detail-label {
        font-size: 13px;
        font-weight: 600;
        color: #64748B;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        flex-shrink: 0;
    }

    .detail-value {
        font-size: 14px;
        color: #1E293B;
        text-align: right;
        font-weight: 500;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid #F1F5F9;
    }

    .section-title {
        font-size: 18px;
        font-weight: 600;
        color: #1E293B;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .section-icon {
        width: 32px;
        height: 32px;
        background: rgba(52, 152, 219, 0.1);
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #3498db;
        font-size: 14px;
    }

    .record-count {
        display: inline-block;
        padding: 6px 12px;
        background: rgba(52, 152, 219, 0.1);
        color: #3498db;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
    }

    .licenses-grid {
        display: grid;
        gap: 16px;
    }

    .license-card {
        background: white;
        border: 1px solid #E2E8F0;
        border-radius: 8px;
        padding: 20px;
        transition: all 0.3s ease;
    }

    .license-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        border-color: #3498db;
    }

    .license-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 16px;
    }

    .license-info {
        flex: 1;
    }

    .license-type {
        font-size: 16px;
        font-weight: 600;
        color: #1E293B;
        margin-bottom: 6px;
    }

    .license-number {
        font-size: 13px;
        color: #64748B;
        font-family: monospace;
    }

    .license-status {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .license-status.active {
        background: #D1FAE5;
        color: #065F46;
    }

    .license-status.expired {
        background: #FEE2E2;
        color: #991B1B;
    }

    .license-status.pending {
        background: #FEF3C7;
        color: #92400E;
    }

    .license-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        padding-top: 16px;
        border-top: 1px solid #F1F5F9;
    }

    .license-detail-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .license-detail-label {
        font-size: 12px;
        font-weight: 600;
        color: #64748B;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .license-detail-value {
        font-size: 14px;
        color: #1E293B;
        font-weight: 500;
    }

    .license-actions {
        display: flex;
        gap: 8px;
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid #F1F5F9;
    }

    .btn-sm {
        padding: 6px 14px;
        font-size: 13px;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
    }

    .empty-icon {
        font-size: 48px;
        color: #CBD5E1;
        margin-bottom: 16px;
    }

    .empty-title {
        font-size: 18px;
        font-weight: 600;
        color: #64748B;
        margin-bottom: 8px;
    }

    .empty-text {
        color: #94A3B8;
        font-size: 14px;
    }

    .map-container {
        height: 300px;
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid #E2E8F0;
    }

    @media (max-width: 768px) {
        .business-header-info {
            flex-direction: column;
        }

        .details-grid {
            grid-template-columns: 1fr;
        }

        .license-details {
            grid-template-columns: 1fr;
        }

        .header-actions {
            width: 100%;
        }

        .btn-primary, .btn-secondary, .btn-danger {
            flex: 1;
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{% url 'admin_dashboard' %}">
                    <i class="bi bi-house-door"></i> Dashboard
                </a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'licenses_dashboard' %}">Licenses & Permits</a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'business_list' %}">Businesses</a>
            </li>
            <li class="breadcrumb-item active">{{ business.business_name }}</li>
        </ol>
    </nav>

    <div class="section-container">
        <!-- Page Header -->
        <div class="page-header">
            <div class="header-left">
                <div class="business-header-info">
                    <div class="business-icon-large">
                        <i class="fas fa-briefcase"></i>
                    </div>
                    <div class="business-header-details">
                        <h1 class="page-title">{{ business.business_name }}</h1>
                        {% if business.trading_name %}
                        <p style="color: #64748B; margin-bottom: 8px;">
                            <i class="bi bi-tag"></i> Trading as: <strong>{{ business.trading_name }}</strong>
                        </p>
                        {% endif %}
                        
                        <div class="business-meta-row">
                            <div class="meta-item">
                                <i class="bi bi-hash"></i>
                                <span>{{ business.business_number }}</span>
                            </div>
                            {% if business.registration_number %}
                            <div class="meta-item">
                                <i class="bi bi-file-text"></i>
                                <span>Reg: {{ business.registration_number }}</span>
                            </div>
                            {% endif %}
                            <div class="meta-item">
                                <i class="bi bi-calendar"></i>
                                <span>Registered: {{ business.registration_date|date:"d M, Y" }}</span>
                            </div>
                            <span class="status-badge status-{% if business.is_active %}active{% else %}inactive{% endif %}">
                                <i class="bi bi-{% if business.is_active %}check-circle{% else %}x-circle{% endif %}"></i>
                                {% if business.is_active %}Active{% else %}Inactive{% endif %}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="header-actions">
                <a href="{% url 'business_update' business.pk %}" class="btn-primary">
                    <i class="bi bi-pencil"></i>
                    Edit Business
                </a>
                <a href="{% url 'business_list' %}" class="btn-secondary">
                    <i class="bi bi-arrow-left"></i>
                    Back to List
                </a>
                <button class="btn-danger" onclick="confirmDelete()">
                    <i class="bi bi-trash"></i>
                    Delete
                </button>
            </div>
        </div>

        <!-- Business Details Grid -->
        <div class="details-grid">
            <!-- Basic Information -->
            <div class="detail-card">
                <div class="detail-card-header">
                    <div class="detail-card-icon">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <h3 class="detail-card-title">Basic Information</h3>
                </div>

                <div class="detail-row">
                    <span class="detail-label">Business Number</span>
                    <span class="detail-value">{{ business.business_number }}</span>
                </div>

                {% if business.registration_number %}
                <div class="detail-row">
                    <span class="detail-label">Registration No.</span>
                    <span class="detail-value">{{ business.registration_number }}</span>
                </div>
                {% endif %}

                <div class="detail-row">
                    <span class="detail-label">Category</span>
                    <span class="detail-value">{{ business.business_category.name }}</span>
                </div>

                <div class="detail-row">
                    <span class="detail-label">Registration Date</span>
                    <span class="detail-value">{{ business.registration_date|date:"d M, Y" }}</span>
                </div>

                <div class="detail-row">
                    <span class="detail-label">Employees</span>
                    <span class="detail-value">{{ business.number_of_employees }}</span>
                </div>

                {% if business.annual_turnover %}
                <div class="detail-row">
                    <span class="detail-label">Annual Turnover</span>
                    <span class="detail-value">KES {{ business.annual_turnover|intcomma }}</span>
                </div>
                {% endif %}
            </div>

            <!-- Owner Information -->
            <div class="detail-card">
                <div class="detail-card-header">
                    <div class="detail-card-icon">
                        <i class="fas fa-user"></i>
                    </div>
                    <h3 class="detail-card-title">Owner Information</h3>
                </div>

                <div class="detail-row">
                    <span class="detail-label">Owner Name</span>
                    <span class="detail-value">
                        {% if business.citizen.entity_type == 'individual' %}
                            {{ business.citizen.first_name }} {{ business.citizen.last_name }}
                        {% else %}
                            {{ business.citizen.business_name }}
                        {% endif %}
                    </span>
                </div>

                <div class="detail-row">
                    <span class="detail-label">ID/Registration</span>
                    <span class="detail-value">{{ business.citizen.unique_identifier }}</span>
                </div>

                <div class="detail-row">
                    <span class="detail-label">Phone</span>
                    <span class="detail-value">{{ business.citizen.phone_primary }}</span>
                </div>

                {% if business.citizen.email %}
                <div class="detail-row">
                    <span class="detail-label">Email</span>
                    <span class="detail-value">{{ business.citizen.email }}</span>
                </div>
                {% endif %}
            </div>

            <!-- Contact Information -->
            <div class="detail-card">
                <div class="detail-card-header">
                    <div class="detail-card-icon">
                        <i class="fas fa-phone"></i>
                    </div>
                    <h3 class="detail-card-title">Contact Information</h3>
                </div>

                <div class="detail-row">
                    <span class="detail-label">Phone</span>
                    <span class="detail-value">{{ business.phone }}</span>
                </div>

                {% if business.email %}
                <div class="detail-row">
                    <span class="detail-label">Email</span>
                    <span class="detail-value">{{ business.email }}</span>
                </div>
                {% endif %}

                <div class="detail-row">
                    <span class="detail-label">Physical Address</span>
                    <span class="detail-value" style="text-align: right; max-width: 200px;">{{ business.physical_address }}</span>
                </div>
            </div>

            <!-- Location Information -->
            <div class="detail-card">
                <div class="detail-card-header">
                    <div class="detail-card-icon">
                        <i class="fas fa-map-marker-alt"></i>
                    </div>
                    <h3 class="detail-card-title">Location</h3>
                </div>

                <div class="detail-row">
                    <span class="detail-label">Sub County</span>
                    <span class="detail-value">{{ business.sub_county.name }}</span>
                </div>

                <div class="detail-row">
                    <span class="detail-label">Ward</span>
                    <span class="detail-value">{{ business.ward.name }}</span>
                </div>

                {% if business.plot_number %}
                <div class="detail-row">
                    <span class="detail-label">Plot Number</span>
                    <span class="detail-value">{{ business.plot_number }}</span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Nature of Business -->
        <div class="section-container">
            <div class="detail-card-header">
                <div class="detail-card-icon">
                    <i class="fas fa-file-alt"></i>
                </div>
                <h3 class="detail-card-title">Nature of Business</h3>
            </div>
            <p style="color: #334155; line-height: 1.6; margin-top: 16px;">
                {{ business.nature_of_business }}
            </p>
        </div>

        <!-- Licenses Section -->
        <div class="section-container">
            <div class="section-header">
                <h2 class="section-title">
                    <div class="section-icon">
                        <i class="fas fa-certificate"></i>
                    </div>
                    Business Licenses
                </h2>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span class="record-count">{{ licenses|length }} license{{ licenses|length|pluralize }}</span>
                    <a href="{% url 'license_create' %}?business={{ business.pk }}" class="btn-primary btn-sm">
                        <i class="bi bi-plus-circle"></i>
                        Add License
                    </a>
                </div>
            </div>

            {% if licenses %}
            <div class="licenses-grid">
                {% for license in licenses %}
                <div class="license-card">
                    <div class="license-header">
                        <div class="license-info">
                            <div class="license-type">{{ license.license_type.name }}</div>
                            <div class="license-number">{{ license.license_number }}</div>
                        </div>
                        <span class="license-status {{ license.status }}">
                            {% if license.status == 'active' %}
                                <i class="bi bi-check-circle"></i> Active
                            {% elif license.status == 'expired' %}
                                <i class="bi bi-x-circle"></i> Expired
                            {% else %}
                                <i class="bi bi-clock"></i> {{ license.get_status_display }}
                            {% endif %}
                        </span>
                    </div>

                    <div class="license-details">
                        <div class="license-detail-item">
                            <span class="license-detail-label">Application Date</span>
                            <span class="license-detail-value">{{ license.application_date|date:"d M, Y" }}</span>
                        </div>

                        {% if license.issue_date %}
                        <div class="license-detail-item">
                            <span class="license-detail-label">Issue Date</span>
                            <span class="license-detail-value">{{ license.issue_date|date:"d M, Y" }}</span>
                        </div>
                        {% endif %}

                        {% if license.expiry_date %}
                        <div class="license-detail-item">
                            <span class="license-detail-label">Expiry Date</span>
                            <span class="license-detail-value">{{ license.expiry_date|date:"d M, Y" }}</span>
                        </div>
                        {% endif %}

                        {% if license.is_renewal %}
                        <div class="license-detail-item">
                            <span class="license-detail-label">Type</span>
                            <span class="license-detail-value">
                                <span style="background: #FEF3C7; color: #92400E; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">
                                    Renewal
                                </span>
                            </span>
                        </div>
                        {% endif %}
                    </div>

                    <div class="license-actions">
                        <a href="{% url 'license_detail' license.pk %}" class="btn-primary btn-sm">
                            <i class="bi bi-eye"></i>
                            View Details
                        </a>
                        <a href="{% url 'license_update' license.pk %}" class="btn-secondary btn-sm">
                            <i class="bi bi-pencil"></i>
                            Edit
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="fas fa-certificate"></i>
                </div>
                <h3 class="empty-title">No Licenses Yet</h3>
                <p class="empty-text">This business doesn't have any licenses registered.</p>
                <a href="{% url 'license_create' %}?business={{ business.pk }}" class="btn-primary" style="margin-top: 16px;">
                    <i class="bi bi-plus-circle"></i>
                    Add First License
                </a>
            </div>
            {% endif %}
        </div>

        <!-- System Information -->
        <div class="section-container" style="background: #F8FAFC;">
            <div class="detail-card-header">
                <div class="detail-card-icon">
                    <i class="fas fa-cog"></i>
                </div>
                <h3 class="detail-card-title">System Information</h3>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-top: 16px;">
                <div class="detail-row">
                    <span class="detail-label">Created By</span>
                    <span class="detail-value">
                        {% if business.created_by %}
                            {{ business.created_by.get_full_name|default:business.created_by.username }}
                        {% else %}
                            System
                        {% endif %}
                    </span>
                </div>

                <div class="detail-row">
                    <span class="detail-label">Created At</span>
                    <span class="detail-value">{{ business.created_at|date:"d M, Y H:i" }}</span>
                </div>

                <div class="detail-row">
                    <span class="detail-label">Last Updated</span>
                    <span class="detail-value">{{ business.updated_at|date:"d M, Y H:i" }}</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function confirmDelete() {
        if (confirm('Are you sure you want to delete this business? This action cannot be undone and will affect all associated licenses.')) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{% url "business_delete" business.pk %}';
            
            const csrfToken = '{{ csrf_token }}';
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken;
            form.appendChild(csrfInput);
            
            document.body.appendChild(form);
            form.submit();
        }
    }
</script>
{% endblock %}